version: 2.1

orbs:
  node: circleci/node@5.2.0
  browser-tools: circleci/browser-tools@1.4.8
  slack: circleci/slack@4.12.5

executors:
  playwright-executor:
    docker:
      - image: mcr.microsoft.com/playwright:v1.57.0-jammy
    resource_class: medium+
    working_directory: ~/playwright-rms-angular
    environment:
      NODE_ENV: test
      FORCE_COLOR: 1

jobs:
  install-dependencies:
    executor: playwright-executor
    steps:
      - checkout
      
      - run:
          name: Print Environment Info
          command: |
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"
            echo "Playwright version: $(npx playwright --version)"
            
      - restore_cache:
          keys:
            - npm-deps-v2-{{ checksum "package-lock.json" }}
            - npm-deps-v2-{{ checksum "package.json" }}
            - npm-deps-v2-
            
      - run:
          name: Install Dependencies
          command: |
            if [ ! -d "node_modules" ]; then
              npm ci --prefer-offline --no-audit
            else
              echo "Using cached node_modules"
            fi
            
      - run:
          name: Verify Playwright Installation
          command: npx playwright install --with-deps
          
      - save_cache:
          key: npm-deps-v2-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm
            - node_modules
            - ~/.cache/ms-playwright
            
      - persist_to_workspace:
          root: ~/playwright-rms-angular
          paths:
            - .
            - node_modules
  run-login-tests:
    executor: playwright-executor
    parallelism: 2
    steps:
      - attach_workspace:
          at: ~/playwright-rms-angular
          
      - run:
          name: Create Test Results Directory
          command: mkdir -p test-results screenshots
          
      - run:
          name: Run Login Tests
          command: |
            echo "Running Login Test Suite"
            npx playwright test tests/e2e/login.spec.ts \
              --reporter=html,junit,list \
              --retries=2 \
              --workers=2
          no_output_timeout: 15m
          
      - run:
          name: Generate Login Test Summary
          when: always
          command: |
            echo "Login tests execution completed"
            if [ -f "test-results/login-results.xml" ]; then
              echo "Test results found"
              cat test-results/login-results.xml | grep -E "(tests=|failures=|errors=)" || true
            fi
            
      - store_test_results:
          path: test-results
          
      - store_artifacts:
          path: test-results
          destination: login-test-results
          
      - store_artifacts:
          path: playwright-report
          destination: login-playwright-report
          
      - store_artifacts:
          path: test-results/screenshots
          destination: login-screenshots
          
      - slack/notify:
          event: fail
          template: basic_fail_1
          
      - slack/notify:
          event: pass
          template: success_tagged_deploy_1

  run-smoke-tests:
    executor: playwright-executor
    steps:
      - attach_workspace:
          at: ~/playwright-rms-angular
          
      - run:
          name: Run Smoke Tests
          command: |
            npx playwright test tests/smoke/ \
              --reporter=html,list \
              --retries=1 \
              --workers=1
              
      - store_test_results:
          path: test-results
          
      - store_artifacts:
          path: playwright-report
          destination: smoke-test-report

  lint-and-validate:
    executor: playwright-executor
    steps:
      - attach_workspace:
          at: ~/playwright-rms-angular
          
      - run:
          name: Run Linting
          command: |
            if [ -f "package.json" ] && grep -q "\"lint\"" package.json; then
              npm run lint || echo "Linting issues found"
            else
              echo "No lint script found, skipping"
            fi
            
      - run:
          name: Type Check
          command: |
            if [ -f "tsconfig.json" ]; then
              npx tsc --noEmit || echo "Type errors found"
            fi

workflows:
  version: 2
  
  # Main test workflow for all branches
  playwright-rms-test-suite:
    jobs:
      - install-dependencies:
          filters:
            branches:
              ignore:
                - gh-pages
                
      - lint-and-validate:
          requires:
            - install-dependencies
            
      - run-smoke-tests:
          requires:
            - install-dependencies
          filters:
            branches:
              only:
                - main
                - master
                - develop
                - /feature\/.*/
                
      - run-login-tests:
          requires:
            - install-dependencies
            - lint-and-validate
          filters:
            branches:
              only:
                - main
                - master
                - develop
                - /feature\/.*/
                
  # Nightly comprehensive test run
  nightly-tests:
    triggers:
      - schedule:
          cron: "0 2 * * *"
          filters:
            branches:
              only:
                - main
                - master
    jobs:
      - install-dependencies
      - lint-and-validate:
          requires:
            - install-dependencies
      - run-smoke-tests:
          requires:
            - install-dependencies
      - run-login-tests:
          requires:
            - install-dependencies
            - lint-and-validate