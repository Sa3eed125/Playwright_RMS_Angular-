version: 2.1

orbs:
  node: circleci/node@5.2.0
  slack: circleci/slack@4.12.5

executors:
  playwright-executor:
    docker:
      - image: mcr.microsoft.com/playwright:v1.57.0-jammy
    resource_class: medium+
    working_directory: ~/playwright-rms-angular
    environment:
      NODE_ENV: test
      FORCE_COLOR: 1

jobs:
  install-dependencies:
    executor: playwright-executor
    steps:
      - checkout
      
      - run:
          name: Print Environment Info
          command: |
            echo "üîç Environment Information:"
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"
            echo "Playwright version: $(npx playwright --version)"
            
      - restore_cache:
          keys:
            - playwright-deps-v3-{{ checksum "package-lock.json" }}
            - playwright-deps-v3-
            
      - run:
          name: Install Dependencies (Smart Cache)
          command: |
            if [ ! -d "node_modules" ]; then
              echo "üì¶ Installing dependencies..."
              npm ci --prefer-offline --no-audit
              echo "‚úÖ Dependencies installed"
            else
              echo "‚ú® Using cached node_modules"
            fi
            
      - run:
          name: Install Playwright Browsers
          command: |
            echo "üé≠ Installing Playwright browsers..."
            npx playwright install chromium --with-deps
            echo "‚úÖ Browsers installed"
          
      - save_cache:
          key: playwright-deps-v3-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm
            - node_modules
            - ~/.cache/ms-playwright
            
      - persist_to_workspace:
          root: ~/playwright-rms-angular
          paths:
            - .
            - node_modules

  run-smoke-tests:
    executor: playwright-executor
    steps:
      - attach_workspace:
          at: ~/playwright-rms-angular
          
      - run:
          name: Run Smoke Tests
          command: |
            echo "üî• Running Smoke Tests..."
            npx playwright test tests/smoke/ \
              --reporter=html,list,json \
              --retries=1 \
              --workers=1
          no_output_timeout: 10m
          
      - store_test_results:
          path: test-results
          
      - store_artifacts:
          path: playwright-report
          destination: smoke-report
          
      - store_artifacts:
          path: test-results/screenshots
          destination: smoke-screenshots
          
      - slack/notify:
          event: fail
          custom: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚ùå *Smoke Tests Failed* on branch: $CIRCLE_BRANCH"
                  }
                }
              ]
            }

  run-login-tests:
    executor: playwright-executor
    steps:
      - attach_workspace:
          at: ~/playwright-rms-angular
          
      - run:
          name: Create Test Results Directory
          command: mkdir -p test-results screenshots
          
      - run:
          name: Run Login Tests
          command: |
            echo "üîê Running Login Tests..."
            npx playwright test tests/e2e/login.spec.ts \
              --reporter=html,list,json \
              --retries=2 \
              --workers=2
          no_output_timeout: 15m
          
      - run:
          name: Generate Test Summary
          when: always
          command: |
            echo "üìä Test Summary:"
            if [ -f "test-results/results.json" ]; then
              echo "Test results found ‚úì"
            fi
            
      - store_test_results:
          path: test-results
          
      - store_artifacts:
          path: test-results
          destination: login-results
          
      - store_artifacts:
          path: playwright-report
          destination: login-report
          
      - store_artifacts:
          path: test-results/screenshots
          destination: login-screenshots
          
      - slack/notify:
          event: fail
          custom: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚ùå *Login Tests Failed* on branch: $CIRCLE_BRANCH"
                  }
                }
              ]
            }
          
      - slack/notify:
          event: pass
          custom: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "‚úÖ *All Tests Passed* on branch: $CIRCLE_BRANCH"
                  }
                }
              ]
            }

workflows:
  version: 2
  
  # Main workflow - runs on every push
  smoke-and-login-tests:
    jobs:
      # Step 1: Install dependencies once
      - install-dependencies:
          filters:
            branches:
              ignore:
                - gh-pages
      
      # Step 2: Run Smoke Tests in parallel with Login Tests
      - run-smoke-tests:
          requires:
            - install-dependencies
          filters:
            branches:
              only:
                - main
                - master
                - develop
                - /feature\/.*/
      
      - run-login-tests:
          requires:
            - install-dependencies
          filters:
            branches:
              only:
                - main
                - master
                - develop
                - /feature\/.*/

  